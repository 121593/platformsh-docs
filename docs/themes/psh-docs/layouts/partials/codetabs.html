<!-- Shortcode separator strings -->
{{ $splitTabChar := "<--->" }}
{{ $paramFrontMatterChar := "\n+++\n" }}

{{ $allParams := newScratch }}
{{ $allContent := newScratch}}

{{ $tabIndex := 0}}
{{ $tabKeys := slice }}
{{ range split .Inner $splitTabChar }}

  {{ $splitParams := ( split . $paramFrontMatterChar ) }}
  {{ $params := index $splitParams 1 }}
  {{ $body := index $splitParams 2 }}

  <!-- Pull out the params  -->
  {{ $tabParams := newScratch }}
  {{ range (split $params "\n") }}
    {{ $key := index ( split . "=" ) 0 }}
    {{ $value := index ( split . "=" ) 1 }}
    {{ $tabParams.Set $key $value }}
  {{ end }}
  {{ $allParams.Set ( string $tabIndex ) $tabParams }}

  <!-- Pull out the content -->
  {{ $allContent.Set ( string $tabIndex ) $body }}


  <!-- Increment ze loop -->
  {{ $tabKeys = $tabKeys | append ( string $tabIndex )}}
  {{ $tabIndex = add $tabIndex 1}}

{{ end }}

<!-- If page doesn't have multiple related codetabs,
     create context just for this set of codetabs -->
<div class="mb-4"
{{ if not $.Page.Params.multipleTabs }}
  x-data="{
    codetab: 'default',
    switchCodetab(targetCodetab) { 
      this.codetab = targetCodetab;
    }
  }"
{{ end }}
>

  <!-- Buttons to control tab visibility-->
    <ul class="flex list-none border-b border-stone m-0 pl-0" role="tablist">

      {{ range $tabKeys }}

        {{ $tabIndex = . }}

        {{ with ( $allParams.Get $tabIndex ) }}

          {{ $title := .Get "title" }}

          <!-- Set the first tab to "default" and others based on the title text -->
          {{ $codetabCodename := $title | urlize }}
          {{ if eq $tabIndex "0" }}
            {{ $codetabCodename = "default" }}
          {{ end }}

          <li class="text-sm xl:text-base border-b mb-0">
            <a class="mx-2 py-1 px-2 text-base xl:text-lg border-ebony text-slate font-semibold hover:text-ebony hover:border-b hover:font-bold hover:no-underline" :class="{ '!text-ebony font-bold border-b': codetab === '{{ $codetabCodename }}' }" role="tab" :aria-selected="codetab === '{{ $codetabCodename }}'" @click="switchCodetab('{{ $codetabCodename }}')">
              {{ $title | markdownify }}
            </a>
          </li>

        {{ end }}

      {{ end }}


    </ul>

    <!-- Tab content -->
    <div class="border border-stone px-5 pt-6 pb-4">

      {{ range $tabKeys }}

        {{ $tabIndex = . }}

        {{ with ( $allParams.Get $tabIndex ) }}

          <!-- Match the title and codename information from the buttons -->
          {{ $title := .Get "title" }}
          {{ $codetabCodename := $title | urlize }}
          {{ if eq $tabIndex "0" }}
            {{ $codetabCodename = "default" }}
          {{ end }}

          <div class="[&>:first-child]:mt-0 [&>:last-child]:mb-0" :class="{ 'show active': codetab === '{{ $codetabCodename }}' }" role="tabpanel" x-show="codetab === '{{ $codetabCodename }}'" :aria-hidden="codetab !== '{{ $codetabCodename }}'">

            {{ $content := $allContent.Get $tabIndex }}
            {{ with ( $allParams.Get $tabIndex ) }}
              {{ if ne (.Get "highlight") "false" }}
                {{ if ne (.Get "file") "none" }}
                  {{ highlight ( readFile ( .Get "file" ) ) ( .Get "highlight") "style=abap" | chomp }}
                {{ else }}
                  {{ highlight $content ( .Get "highlight") "style=abap" | chomp }}
                {{ end }}
              {{ else }}
                {{ if ne (.Get "file") "none" }}
                  {{  readFile ( .Get "file" ) | markdownify | chomp }}
                {{ else }}
                  {{ $content | $.Page.RenderString }}
                {{ end }}
              {{ end }}
            {{ end }}

          </div>

          {{ end }}

      {{ end }}

    </div>

</div>
