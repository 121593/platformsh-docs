{{ $ignoreBooks := .books }}
{{ $currentPage := .Page}}
{{ $rootSections := .Site.Sections }}
{{ $home := .Site.Home}}
{{ with .context }}
  {{ $currentPage = .Page}}
  {{ $rootSections = .Site.Sections }}
{{ end }}

{{ range $rootSections }}
  {{ if in $ignoreBooks .Section }}
  {{ else if .Params.sidebarIgnore }}
  {{ else }}

    <!-- SECTION HEADING -->
    {{ $sectionHeading := printf "section-%s" .Title | urlize }}
    {{ $isCurrentSection := false }}
    {{ $currentSection := .Section}}
    {{ with $currentPage.File }}
      <!-- If on home page or in the current section -->
      {{ if or (and ($currentPage.IsHome) ( eq $currentSection "overview" )) (hasPrefix . $currentSection) }}
        {{ $isCurrentSection = true }}
      {{ end }}
    {{ end }}
    <div class="pl-5 pr-2">
      <div class="sidebar__section-wrapper">
        <h4 class="duik-sidebar__heading">{{ .Title }}</h4>
        <!-- Add button for expanding -->
        {{ partial "navigation/sidebar/expand-button" (dict "itemID" $sectionHeading "isCurrentSection" $isCurrentSection )}}
      </div>
      <ul class="duik-sidebar__nav dropdown-menu{{ if eq $isCurrentSection true }} show{{ end }}" aria-labelledby="nav-expand-{{ .Title | urlize }}" id="{{ $sectionHeading }}">

      <!-- Add the homepage as the first entry of the first section -->

      {{ if eq "overview" .Section }}

        <!-- FIRST LEVEL ITEM -->
        <li class="duik-sidebar__item">
          <a href="/" class="duik-sidebar__link{{ if $currentPage.IsHome }} active{{ end }}">
              {{ .Site.Home.Title }}
          </a>
        </li>

      {{ end }}

      <!-- Loop through pages in the section -->
      {{ range .Pages }}
        {{ $itemTitle := .Title }}
        {{ if isset .Params "sidebartitle" }}
          {{ $itemTitle = .Params.sidebarTitle }}
        {{ end }}
        {{ $itemId := ( $itemTitle | urlize ) }}


        <!-- FIRST LEVEL ITEM -->
        <!-- Check if current page is in this hierarchy -->
        {{ $levelTwoPages := .Pages }}
        {{ if or (eq $currentPage .Parent) (in $levelTwoPages $currentPage ) ( eq $currentPage . ) }}
          {{ $isCurrentSection = true }}
        {{ else }}
          {{ $isCurrentSection = false }}
        {{ end }}

        <li class="duik-sidebar__item">
          {{ if eq .Kind "section"}}<div class="sidebar__section-wrapper">{{ end }}
            <a href="{{ .RelPermalink }}" class="duik-sidebar__link{{ if $isCurrentSection }} active{{ end }}">
                {{ $itemTitle }}
            </a>

            <!-- If this item has children -->
            {{ if eq .Kind "section"}}

              <!-- Add button for expanding -->
              {{ partial "navigation/sidebar/expand-button" (dict "itemID" $itemId "isCurrentSection" $isCurrentSection )}}
              </div>
              <ul class="duik-sidebar__nav dropdown-menu second-level{{ if eq $isCurrentSection true }} show{{ end }}" aria-labelledby="nav-expand-{{ .Title | urlize }}" id="{{ $itemTitle | urlize }}">

                <!-- Loop through children -->
                {{ range $levelTwoPages }}

                  {{ if not ( isset .Params "sidebarIgnore" )}}
                    <!-- SECOND LEVEL ITEM -->
                    <li class="duik-sidebar__item second-level">
                      <a href="{{ .RelPermalink }}" class="duik-sidebar__link{{ if eq $currentPage . }} active{{ end }}">
                          {{ if isset .Params "sidebartitle" }}{{ .Params.sidebarTitle }}{{ else }}{{ .Title }}{{ end }}
                      </a>
                    </li>
                  {{ end }}
                {{ end }}

              </ul>
            {{ end }}
      </li>

      {{ end }}


      </ul>
    </div>
  {{ end }}
{{ end }}
